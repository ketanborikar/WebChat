<script>
function startPrivateChat(receiver) {
    const chatWindow = window.open("", receiver, "width=400,height=500");
    const username = localStorage.getItem("username");  // ‚úÖ Ensure username is correctly retrieved

    const popupHTML = `
        <h3>Private Chat with ${receiver}</h3>
        <div id="privateChatBox"></div>
        <input type="text" id="privateMessageInput" placeholder="Type message">
        <button id="privateSendButton">Send</button>

        <script>
            (function(){
                const socket = io.connect("${window.location.origin}");
                const userName = "${username}"; // ‚úÖ Fixed username retrieval
                
                function sendPrivateMessage() {
                    const message = document.getElementById("privateMessageInput").value.trim();
                    console.log("üîç Sending private message:", message);
                    
                    if (message) {
                        socket.emit("private_message", { sender: userName, receiver: "${receiver}", message });
                        document.getElementById("privateMessageInput").value = "";
                    }
                }

                document.getElementById("privateSendButton").addEventListener("click", sendPrivateMessage);
                document.getElementById("privateMessageInput").addEventListener("keydown", function(e) {
                    if (e.key === "Enter") {
                        e.preventDefault();
                        sendPrivateMessage();
                    }
                });

                socket.on("private_${receiver}", function(msg) {
                    console.log("üîç Received private message:", msg);
                    const chatBox = document.getElementById("privateChatBox");
                    const msgElem = document.createElement("p");
                    msgElem.classList.add("private-message");
                    msgElem.textContent = msg;
                    chatBox.appendChild(msgElem);
                    chatBox.scrollTop = chatBox.scrollHeight;
                });
            })();
        <\/script>
    `;
    chatWindow.document.write(popupHTML);
}
</script>
